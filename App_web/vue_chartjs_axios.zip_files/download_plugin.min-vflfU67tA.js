define(["require","exports","tslib","react","metaserver/static/js/modules/core/i18n","dig-components/menu","dig-components/buttons","dig-components/icons/src","dig-components/icons","dig-components/tooltips","metaserver/static/js/modules/clean/react/action_bar/action_bar_strings","metaserver/static/js/modules/clean/react/action_bar/file_actions/portable/utils","metaserver/static/js/modules/clean/react/action_bar/file_actions/portable/download","metaserver/static/js/modules/clean/react/file_viewer/sdk_file_viewer/action_plugins/utils","metaserver/static/js/modules/clean/file_store/utils","metaserver/static/js/modules/clean/react/share_download/util","metaserver/static/js/modules/clean/react/file_viewer/sdk_file_viewer/download_utils","metaserver/static/js/modules/clean/react/file_viewer/sdk_file_viewer/utils","metaserver/static/js/modules/clean/user_survey/user_survey","metaserver/static/js/modules/clean/sync_everything/constants","metaserver/static/js/modules/clean/react/browse/data/selectors","metaserver/static/js/modules/clean/react/browse/data/store","metaserver/static/js/modules/clean/react/file_viewer/sdk_file_viewer/utils"],(function(e,t,o,n,a,l,s,i,r,c,d,u,m,f,_,w,p,v,g,b,S,A,I){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.makeDownloadPlugin=void 0,n=o.__importDefault(n);const D=[v.SDKPreviewSurface.BROWSE,v.SDKPreviewSurface.SEARCH,v.SDKPreviewSurface.STANDALONE_PREVIEW];t.makeDownloadPlugin=(e,t,o,l,s,c,v,O)=>{const P=u.makePluginActionDefinition({label:a.intl.formatMessage(d.DOWNLOAD_ACTION_STRING),icon:n.default.createElement(r.UIIcon,{src:i.DownloadLine}),id:I.DOWNLOAD_ACTION_PLUGIN_ID,action:()=>{o.logUserAction({action:"download",context:"title_bar_open_split_button"});const{file:n}=e();(e=>{D.includes(e)&&g.UserSurvey.trackEvent("download_item","previews")})(t);const{rootNSID:a,blockHash:s}=S.getBrowseState(A.getStoreForBrowse().getState()).context;l&&a&&b.isUnmountedBackupBrowse(l,a)?s&&_.isBrowseFile(n)&&m.downloadSingleFileAsZip({fqPath:n.fq_path,rootNsId:a,source:"PREVIEWS",blockHash:s,user:l}):m.downloadSingleFile({href:n.href,source:"PREVIEWS",isFswm:_.isSharedFile(n)})}}),h=E({downloadAllowed:!!c&&w.isDownloadAllowed(c),downloadAction:()=>{o.logUserAction({action:"download",context:"title_bar_download_split_button"});const{file:t}=e();p.downloadActiveFile(t,l,v,O,o.logUserAction)},saveACopyToDropboxAction:()=>{const{file:t}=e();p.saveToDropbox(t,e=>o.logUserAction({action:e,context:"title_bar_download_split_button"}),l,s,v)},getActiveFile:e,user:l,shareToken:s,encryptionOptions:v}),N=()=>{const{file:t}=e();return!f.isLiveFile(t)||f.isPnmLinkNodeSelected(t)||f.isCloudDoc(t)?[]:_.isSharedFile(t)?[h]:[P]},T={atTopLevelIfSpace:N(),alwaysInOverflow:[N()]};return{lifecycle:{previewWillInitialize:()=>{T.atTopLevelIfSpace=N(),T.alwaysInOverflow=[N()]}},actionDefinitions:T}};const E=({downloadAction:e,saveACopyToDropboxAction:t,shareToken:o,downloadAllowed:m})=>{const f=n.default.createElement(r.UIIcon,{src:i.DownloadLine}),_=a.intl.formatMessage(d.DOWNLOAD_ACTION_STRING),w=e=>{e.menuItem.handler()},p=t=>{t.preventDefault(),t.stopPropagation(),e()},v=t=>{"Enter"===t.key&&(t.preventDefault(),t.stopPropagation(),e())},g=u.getCustomActionOverflowItem({icon:f,label:_,action:e,id:I.DOWNLOAD_ACTION_PLUGIN_ID});let b=null;o&&(b=u.getCustomActionOverflowItem({icon:n.default.createElement(r.UIIcon,{src:i.DropboxLine}),label:a.intl.formatMessage({id:"WiS7tZ",defaultMessage:"Save a copy to Dropbox"}),action:()=>{t()},id:"SHARECOPY_ACTION"}));const S=n.default.createElement(n.default.Fragment,null,g,b),A=({buttonProps:e})=>n.default.createElement(l.Menu.Wrapper,{onSelection:w},({getTriggerProps:t,getContentProps:o})=>n.default.createElement(n.default.Fragment,null,n.default.createElement(s.Button,Object.assign({"aria-label":"Show options"},e,t(),{disabled:!m})),n.default.createElement(l.Menu.Content,Object.assign({},o(),{placement:"bottom-end"}),n.default.createElement(l.Menu.Segment,null,S)))),D=e=>n.default.createElement(c.Tooltip,{title:a.intl.formatMessage({id:"3IQVpL",defaultMessage:"You do not have permission to download this file"})},n.default.createElement("div",null,e)),E=n.default.createElement(l.Menu.Submenu,{disabled:!m,withTriggerContent:_,withLeftAccessory:f},n.default.createElement(l.Menu.Segment,null,S));return{renderButton:e=>{const t=n.default.createElement(s.SplitButton,{onClick:p,onKeyPress:v,variant:"opacity",renderMenu:A,disabled:!m},!e&&f,_);return m?t:D(t)},overflowItem:m?E:D(E)}}}));
//# sourceMappingURL=download_plugin.min.js-vfl_xxIES.map